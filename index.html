<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MASTER 2D AMO · EXACT LOGIC + AI</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Padauk:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <!-- Html5Qrcode -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        /* ========== BASE STYLES (unchanged except chat additions) ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Padauk', sans-serif;
        }
        :root {
            --gold: #D4AF37;
            --gold-light: #f5d742;
            --gold-dark: #b88a1f;
            --bg: #0a0a0a;
            --bg-card: #111111;
            --bg-input: #1a1a1a;
            --border: #2a2a2a;
            --text: #ffffff;
            --text-muted: #888888;
            --success: #2e7d32;
            --danger: #b71c1c;
            --info: #2196F3;
            --accent: #00ffff;
            --neon-green: #39ff14;
            --neon-red: #ff004c;
        }
        body {
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .app-container {
            max-width: 500px;
            margin: 0 auto;
            width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg);
            position: relative;
        }
        .header {
            background: linear-gradient(145deg, #0f0f0f, #1a1a1a);
            border-bottom: 2px solid var(--gold);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            font-size: 18px;
            color: var(--gold);
            text-shadow: 0 0 10px rgba(212,175,55,0.3);
            letter-spacing: 1px;
        }
        .sync-status {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(46,125,50,0.1);
            padding: 4px 10px;
            border-radius: 20px;
            border: 1px solid var(--success);
        }
        .sync-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity:1; transform:scale(1); }
            50% { opacity:0.5; transform:scale(1.2); }
            100% { opacity:1; transform:scale(1); }
        }
        .nav-tabs {
            display: flex;
            background: var(--bg-card);
            padding: 8px;
            gap: 6px;
            border-bottom: 1px solid var(--border);
        }
        .nav-btn {
            flex: 1;
            padding: 10px 4px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
            border-radius: 8px;
            font-weight: bold;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .nav-btn i { font-size: 14px; }
        .nav-btn.active {
            border-color: var(--gold);
            color: var(--gold);
            background: rgba(212,175,55,0.1);
        }
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .panel-title {
            font-size: 12px;
            color: var(--gold);
            margin-bottom: 12px;
            font-weight: bold;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .display-panel {
            background: #000;
            border: 2px solid var(--gold);
            border-radius: 12px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        .display-label {
            position: absolute;
            top: 8px;
            left: 16px;
            font-size: 10px;
            color: var(--gold);
            opacity: 0.5;
            font-family: monospace;
        }
        .display-value {
            text-align: right;
            font-size: 48px;
            font-family: 'Orbitron', monospace;
            font-weight: 900;
            color: white;
            line-height: 1.2;
        }
        .display-unit {
            font-size: 16px;
            color: var(--gold);
            opacity: 0.7;
            margin-left: 8px;
        }
        .voucher-header, .voucher-row {
            display: grid;
            grid-template-columns: 40px 80px 60px 40px 60px 40px 60px 80px 40px;
            gap: 2px;
            align-items: center;
            font-size: 12px;
        }
        .voucher-header {
            background: rgba(255,255,255,0.05);
            padding: 8px;
            border-radius: 8px;
            color: var(--text-muted);
            font-weight: bold;
        }
        .voucher-row {
            padding: 8px;
            border-bottom: 1px solid var(--border);
        }
        .delete-btn {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
        }
        .total-bar {
            background: var(--gold);
            color: black;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: 900;
            font-size: 20px;
            font-family: 'Orbitron', sans-serif;
            margin: 8px 0;
        }
        .keypad-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 8px;
        }
        .key {
            background: linear-gradient(145deg, #1a1a1a, #222);
            border: 1px solid var(--border);
            color: white;
            border-radius: 12px;
            padding: 16px 4px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .key:active { transform: scale(0.95); background:#2a2a2a; }
        .key.logic { background:#1a3a1a; color:#aaffaa; border-color:#2a5a2a; }
        .key.accent { background:#1a3a4a; color:#aaddff; border-color:#2a5a6a; }
        .key.enter {
            background: var(--gold);
            color: black;
            font-weight: 900;
            grid-column: span 2;
            border-color: var(--gold-dark);
        }
        .key.danger { background: var(--danger); color: white; }
        .key.info { background: var(--info); color: white; }
        .key.space { background:#2a2a2a; color: var(--gold); }
        .sniper-panel {
            background: #0f1a0f;
            border: 2px solid var(--neon-green);
            border-radius: 24px;
            padding: 24px;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(57,255,20,0.2);
        }
        .sniper-panel.locked {
            border-color: var(--neon-red);
            box-shadow: 0 0 30px rgba(255,0,76,0.3);
        }
        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%,-50%);
            width: 200px;
            height: 200px;
            border: 2px solid currentColor;
            border-radius: 50%;
            opacity: 0.1;
            pointer-events: none;
        }
        .crosshair::before,
        .crosshair::after {
            content: '';
            position: absolute;
            background: currentColor;
        }
        .crosshair::before {
            top: 50%;
            left: 0;
            width: 100%;
            height: 2px;
            transform: translateY(-50%);
        }
        .crosshair::after {
            left: 50%;
            top: 0;
            width: 2px;
            height: 100%;
            transform: translateX(-50%);
        }
        .sniper-time {
            font-family: 'Orbitron', monospace;
            font-size: 32px;
            font-weight: 700;
            margin: 16px 0;
            text-shadow: 0 0 10px currentColor;
        }
        .sniper-data {
            display: flex;
            gap: 16px;
            margin: 20px 0;
        }
        .sniper-data-item {
            flex: 1;
            background: rgba(0,0,0,0.5);
            border-radius: 12px;
            padding: 12px;
        }
        .sniper-data-label {
            font-size: 10px;
            opacity: 0.6;
            margin-bottom: 4px;
        }
        .sniper-data-value {
            font-family: 'Orbitron', monospace;
            font-size: 18px;
            font-weight: 700;
        }
        .sniper-prediction {
            font-family: 'Orbitron', monospace;
            font-size: 72px;
            font-weight: 900;
            margin: 20px 0;
            letter-spacing: 4px;
        }
        .sniper-status {
            font-size: 12px;
            padding: 8px;
            border-radius: 20px;
            background: rgba(255,255,255,0.05);
            display: inline-block;
            margin-top: 12px;
        }
        .blink { animation: blink 1s step-end infinite; }
        @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.3;} }
        .history-results {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            margin-top: 16px;
            flex-wrap: wrap;
        }
        .history-day {
            flex: 1;
            min-width: 50px;
            background: #1a1a1a;
            border-radius: 8px;
            padding: 8px 4px;
            text-align: center;
            border: 1px solid var(--border);
        }
        .history-day .date { font-size:10px; color:var(--gold); margin-bottom:4px; }
        .history-day .result { font-family:'Orbitron',monospace; font-size:16px; font-weight:bold; }
        .ledger-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            background: var(--border);
            padding: 8px;
            border-radius: 8px;
        }
        .ledger-col { background: var(--bg-card); border-radius:4px; }
        .ledger-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }
        .ledger-num { color:var(--gold); font-weight:bold; font-family:monospace; }
        .ledger-edit-input {
            width:100%; background:#000; color:#fff; border:1px solid var(--gold);
            text-align:right; font-size:14px; padding:4px; border-radius:4px;
        }
        .modal {
            display: none;
            position: fixed;
            top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.95);
            z-index:2000;
            justify-content: center;
            align-items: center;
            padding:20px;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 20px;
            max-width: 450px;
            width:100%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .preview-edit-row {
            display: grid;
            grid-template-columns: 1fr 1fr 40px 70px 40px 70px 50px 40px;
            gap: 4px;
            margin-bottom: 8px;
            background: #f0f0f0;
            padding: 8px;
            border-radius: 6px;
            align-items: center;
        }
        .preview-edit-input { padding:6px; border:1px solid #ccc; border-radius:4px; font-size:12px; }
        canvas { width:100%; border:2px solid #333; border-radius:8px; background:white; }
        .modal-buttons { display:flex; gap:8px; margin-top:16px; }
        .modal-btn { flex:1; padding:12px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; }
        #qrScannerBox { background: var(--bg-card); border:1px solid var(--gold); border-radius:12px; padding:16px; margin-top:12px; }
        #qrReader { width:100%; min-height:200px; background:#000; border-radius:8px; overflow:hidden; }
        .history-item {
            background:#111; margin-bottom:12px; padding:12px; border-radius:8px;
            border:1px solid var(--border); position:relative;
        }
        .history-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
        .history-time { font-weight:bold; color:var(--gold); }
        .history-actions { display:flex; gap:8px; }
        .history-edit-btn, .history-delete-btn {
            background:var(--info); color:white; border:none; border-radius:4px; padding:4px 8px; font-size:11px; cursor:pointer;
        }
        .history-delete-btn { background:var(--danger); }
        .history-total { font-size:16px; font-weight:bold; color:var(--neon-green); }
        .history-items-preview { font-size:12px; color:var(--text-muted); margin-top:8px; }

        /* ===== AI Chat Tab Styles (from second file) ===== */
        #ai-tab {
            background: #e5ddd5;  /* WhatsApp-like background */
            color: #111;
        }
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: #e5ddd5;
            border-radius: 16px;
            overflow: hidden;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .chat-msg {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .chat-msg.user {
            align-self: flex-end;
            background: #dcf8c6;
            color: #000;
            border-bottom-right-radius: 2px;
        }
        .chat-msg.ai {
            align-self: flex-start;
            background: #fff;
            color: #000;
            border-bottom-left-radius: 2px;
        }
        .chat-msg.system {
            align-self: center;
            background: #fff3cd;
            color: #856404;
            font-style: italic;
            max-width: 90%;
        }
        .chat-input-area {
            background: #f0f0f0;
            padding: 12px;
            display: flex;
            gap: 8px;
            border-top: 1px solid #ccc;
        }
        .chat-input-area input {
            flex: 1;
            padding: 12px;
            border-radius: 25px;
            border: 1px solid #ddd;
            outline: none;
            background: white;
            color: black;
        }
        .chat-input-area button {
            background: #075e54;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
        }
        .chat-input-area button:hover { opacity: 0.9; }
        pre { background: #282c34; color: #abb2bf; padding: 10px; border-radius: 8px; overflow-x: auto; }
        code { background: rgba(0,0,0,0.05); padding: 2px 4px; border-radius: 4px; color: #d32f2f; }
        pre code { background: transparent; color: inherit; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <div class="logo"><i class="fas fa-crown" style="color:var(--gold); margin-right:6px;"></i>MASTER 2D</div>
            <div class="sync-status"><span class="sync-dot"></span><span style="font-size:11px;">LIVE API</span></div>
        </div>
        <!-- Navigation (added AI tab) -->
        <div class="nav-tabs">
            <button class="nav-btn active" onclick="switchTab('pos')"><i class="fas fa-calculator"></i> အရောင်း</button>
            <button class="nav-btn" onclick="switchTab('live')"><i class="fas fa-crosshairs"></i> SNIPER</button>
            <button class="nav-btn" onclick="switchTab('ledger')"><i class="fas fa-table"></i> လယ်ဂျာ</button>
            <button class="nav-btn" onclick="switchTab('history')"><i class="fas fa-history"></i> History</button>
            <button class="nav-btn" onclick="switchTab('ai')"><i class="fas fa-robot"></i> AI</button>
        </div>

        <!-- POS TAB (unchanged) -->
        <div id="pos-tab" class="content-area" style="display:flex;">
            <div class="display-panel">
                <div class="display-label"><i class="fas fa-circle" style="font-size:6px;"></i> DIGITAL DISPLAY</div>
                <div class="display-value"><span id="displayInput">0</span><span class="display-unit">Ks</span></div>
            </div>
            <div class="voucher-header">
                <div>No</div><div>နံပါတ်</div><div>Logic</div><div>R1</div><div>AMT1</div><div>R2</div><div>AMT2</div><div>Total</div><div>Del</div>
            </div>
            <div id="voucherList" style="flex:1; overflow-y:auto;"></div>
            <div class="total-bar" id="posTotal">0 Ks</div>
            <!-- Keypad -->
            <div class="keypad-grid">
                <button class="key logic" onclick="addToDisplay('ပါဝါ ')">ပါဝါ</button>
                <button class="key logic" onclick="addToDisplay('နတ်က္ခ ')">နတ်က္ခ</button>
                <button class="key logic" onclick="addToDisplay('အပူး ')">အပူး</button>
                <button class="key logic" onclick="addToDisplay('ညီကို ')">ညီကို</button>
                <button class="key logic" onclick="addToDisplay('ထိပ် ')">ထိပ်</button>
                <button class="key logic" onclick="addToDisplay('ဘိတ် ')">ဘိတ်</button>
                <button class="key logic" onclick="addToDisplay('ပွင့် ')">ပွင့်</button>
                <button class="key logic" onclick="addToDisplay('ခွေ ')">ခွေ</button>
                <button class="key accent" onclick="addToDisplay('အပါ ')">အပါ</button>
                <button class="key accent" onclick="addToDisplay('အပူး+အပါ ')">အပူး+အပါ</button>
                <button class="key accent" onclick="addToDisplay('အပူးပါခွေ ')">အပူးပါခွေ</button>
                <button class="key info" onclick="showPreviewModal()"><i class="fas fa-print"></i> စမ်းထုတ်</button>
                <button class="key danger" onclick="deleteLast()"><i class="fas fa-backspace"></i></button>
                <button class="key" onclick="addToDisplay('7')">7</button>
                <button class="key" onclick="addToDisplay('8')">8</button>
                <button class="key" onclick="addToDisplay('9')">9</button>
                <button class="key" onclick="addToDisplay('4')">4</button>
                <button class="key" onclick="addToDisplay('5')">5</button>
                <button class="key" onclick="addToDisplay('6')">6</button>
                <button class="key logic" onclick="addToDisplay(' R ')">R</button>
                <button class="key" onclick="addToDisplay('1')">1</button>
                <button class="key" onclick="addToDisplay('2')">2</button>
                <button class="key" onclick="addToDisplay('3')">3</button>
                <button class="key space" onclick="addToDisplay(' ')">Space</button>
                <button class="key" onclick="addToDisplay('0')">0</button>
                <button class="key" onclick="addToDisplay('00')">00</button>
                <button class="key enter" onclick="processEnter()">ENTER</button>
            </div>
        </div>

        <!-- LIVE SNIPER TAB (unchanged) -->
        <div id="live-tab" class="content-area" style="display:none;">
            <div id="sniperPanel" class="sniper-panel">
                <div class="crosshair"></div>
                <div style="position:relative; z-index:10;">
                    <h1 style="font-family:'Orbitron'; font-size:24px; letter-spacing:8px; opacity:0.8;">VOYAGER</h1>
                    <h2 style="font-family:'Orbitron'; font-size:18px; letter-spacing:4px; opacity:0.6;">SNIPER</h2>
                    <div class="sniper-time" id="sniperTime">--:--:--</div>
                    <div class="sniper-data">
                        <div class="sniper-data-item"><div class="sniper-data-label">SET INDEX</div><div class="sniper-data-value" id="setIndex">----.--</div></div>
                        <div class="sniper-data-item"><div class="sniper-data-label">VALUE</div><div class="sniper-data-value" id="setValue">----.--</div></div>
                    </div>
                    <div class="sniper-prediction" id="sniperPrediction">--</div>
                    <div class="sniper-status" id="sniperStatus">CONNECTING...</div>
                    <div style="font-size:10px; margin-top:16px; opacity:0.3;">TARGET: 16:00 | LOGIC: SET.dec + VAL.int</div>
                </div>
            </div>
            <div class="panel">
                <div class="panel-title"><i class="fas fa-calendar-week"></i> အတည်ပြုထွက်ပြီး 2D (၇ ရက်)</div>
                <div class="history-results" id="lastSevenDays"></div>
            </div>
            <div class="panel">
                <div class="panel-title"><i class="fas fa-chart-line"></i> ယနေ့ထွက်ရှိ 2D</div>
                <div style="font-family:'Orbitron'; font-size:64px; text-align:center; color:var(--gold);" id="live2D">--</div>
            </div>
            <div class="panel">
                <div class="panel-title"><i class="fas fa-search"></i> WEB SEARCH</div>
                <div style="display:flex; gap:8px;">
                    <input type="text" id="webSearchInput" placeholder="Search..." style="flex:1; background:var(--bg-input); border:1px solid var(--border); color:white; padding:12px; border-radius:8px;">
                    <button onclick="webSearch()" style="background:var(--info); color:white; border:none; border-radius:8px; padding:0 16px; cursor:pointer;"><i class="fas fa-search"></i></button>
                </div>
                <div id="searchResult" style="margin-top:12px; font-size:12px; color:var(--text-muted);"></div>
            </div>
        </div>

        <!-- LEDGER TAB (unchanged) -->
        <div id="ledger-tab" class="content-area" style="display:none;">
            <div class="panel">
                <div class="panel-title"><i class="fas fa-qrcode"></i> QR SYNC</div>
                <div style="display:flex; gap:8px;">
                    <button onclick="generateQR()" style="flex:1; background:var(--success); color:white; border:none; padding:12px; border-radius:8px;">QR ထုတ်</button>
                    <button onclick="startScanner()" style="flex:1; background:var(--info); color:white; border:none; padding:12px; border-radius:8px;">QR ဖတ်</button>
                    <button onclick="toggleLedgerEdit()" style="flex:1; background:var(--gold); color:black; border:none; padding:12px; border-radius:8px;">ပြင်</button>
                </div>
            </div>
            <div id="qrScannerBox" style="display:none;">
                <div id="qrReader"></div>
                <button onclick="stopScanner()" style="width:100%; margin-top:8px; background:var(--danger); color:white; border:none; padding:10px;">Camera ပိတ်</button>
            </div>
            <div id="qrGeneratorBox" style="display:none; background:white; border-radius:12px; padding:20px; text-align:center;">
                <canvas id="qrCanvas"></canvas>
                <div style="margin-top:12px; display:flex; gap:8px;">
                    <button onclick="downloadQR()" style="flex:1; background:var(--success); color:white; border:none; padding:8px;">Save QR</button>
                    <button onclick="closeQRGenerator()" style="flex:1; background:var(--danger); color:white; border:none; padding:8px;">Close</button>
                </div>
            </div>
            <div class="panel" style="flex:1; display:flex; flex-direction:column;">
                <div class="panel-title"><i class="fas fa-table"></i> LEDGER MASTER</div>
                <div style="margin-bottom:12px; text-align:right; font-family:'Orbitron'; font-size:20px; color:var(--gold);" id="grandTotal">0 Ks</div>
                <div class="ledger-grid" id="ledgerGrid" style="flex:1; overflow-y:auto;"></div>
            </div>
            <button onclick="resetAllData()" style="background:var(--danger); color:white; border:none; padding:16px; border-radius:8px; font-weight:bold;">RESET စာရင်းအားလုံး</button>
        </div>

        <!-- HISTORY TAB (unchanged) -->
        <div id="history-tab" class="content-area" style="display:none;">
            <div class="panel" style="flex:1; display:flex; flex-direction:column;">
                <div class="panel-title"><i class="fas fa-history"></i> ဘောင်ချာမှတ်တမ်း (Edit လုပ်နိုင်)</div>
                <div id="historyList" style="flex:1; overflow-y:auto;"></div>
                <div class="total-bar" id="historyCount" style="margin-top:12px;">မှတ်တမ်း 0 ခု</div>
            </div>
        </div>

        <!-- AI CHAT TAB (new) -->
        <div id="ai-tab" class="content-area" style="display:none;">
            <div class="chat-container">
                <div class="chat-messages" id="aiChatMessages"></div>
                <div class="chat-input-area">
                    <input type="text" id="aiChatInput" placeholder="မေးခွန်းမေးရန်..." onkeypress="if(event.key==='Enter') aiSend()">
                    <button onclick="aiSend()">ပို့</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Modal (unchanged) -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <h3 style="text-align:center; margin-bottom:16px;">ဘောင်ချာအစမ်းကြည့်</h3>
            <div id="previewEditArea" style="margin-bottom:16px;"></div>
            <canvas id="printCanvas"></canvas>
            <div class="modal-buttons">
                <button class="modal-btn" style="background:#333; color:white;" onclick="closeModal()">မထုတ်တော့ပါ</button>
                <button class="modal-btn" style="background:var(--info); color:white;" onclick="printOnly()">ပရင့်ထုတ်</button>
                <button class="modal-btn" style="background:var(--success); color:white;" onclick="printAndAddToLedger()">ထုတ်+လယ်ဂျာ</button>
            </div>
        </div>
    </div>

    <!-- History Edit Modal (unchanged) -->
    <div id="historyEditModal" class="modal">
        <div class="modal-content">
            <h3 style="text-align:center; margin-bottom:16px;">History ပြင်ဆင်ရန်</h3>
            <div id="historyEditContent"></div>
            <div class="modal-buttons">
                <button class="modal-btn" style="background:#333; color:white;" onclick="closeHistoryEdit()">မပြင်တော့ပါ</button>
                <button class="modal-btn" style="background:var(--success); color:white;" onclick="saveHistoryEdit()">သိမ်းမည်</button>
            </div>
        </div>
    </div>

    <script>
        // ====================  GROUPS (same as original) ====================
        const GROUPS = {
            "ပါဝါ": ["05","50","16","61","27","72","38","83","49","94"],
            "နတ်က္ခ": ["07","70","18","81","24","42","35","53","69","96"],
            "အပူး": ["00","11","22","33","44","55","66","77","88","99"],
            "ညီကို": ["01","10","12","21","23","32","34","43","45","54","56","65","67","76","78","87","89","98","90","09"]
        };

        let currentVouchers = [];
        let masterData = Array(100).fill(0);
        let voucherHistory = [];
        let html5QrCode = null;
        let ledgerEditMode = false;
        let sniperInterval = null;
        let isSniperLocked = false;
        let displayBuffer = "";
        let editingHistoryIndex = -1;

        const lastSevenResults = [
            { date: "02/17", result: "45" },
            { date: "02/18", result: "78" },
            { date: "02/19", result: "12" },
            { date: "02/20", result: "33" },
            { date: "02/21", result: "91" },
            { date: "02/22", result: "24" },
            { date: "02/23", result: "56" }
        ];

        window.onload = function() {
            loadLedger();
            loadHistory();
            renderVoucherList();
            renderLedger();
            renderHistoryList();
            updateDisplayValue();
            startSniper();
            renderLastSevenDays();
            // AI chat initial message
            aiAddSystemMsg("မင်္ဂလာပါ။ ကျွန်ုပ်သည် AI အကူအညီပေးရေးစနစ်ဖြစ်ပါသည်။ မေးလိုသည်များကို မေးမြန်းနိုင်ပါသည်။");
        };

        function renderLastSevenDays() {
            const container = document.getElementById('lastSevenDays');
            let html = '';
            lastSevenResults.forEach(day => {
                html += `<div class="history-day"><div class="date">${day.date}</div><div class="result">${day.result}</div></div>`;
            });
            container.innerHTML = html;
        }

        function switchTab(tab) {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.content-area').forEach(area => area.style.display = 'none');
            if (tab === 'pos') {
                document.getElementById('pos-tab').style.display = 'flex';
                document.querySelectorAll('.nav-btn')[0].classList.add('active');
            } else if (tab === 'live') {
                document.getElementById('live-tab').style.display = 'flex';
                document.querySelectorAll('.nav-btn')[1].classList.add('active');
            } else if (tab === 'ledger') {
                document.getElementById('ledger-tab').style.display = 'flex';
                document.querySelectorAll('.nav-btn')[2].classList.add('active');
                renderLedger();
            } else if (tab === 'history') {
                document.getElementById('history-tab').style.display = 'flex';
                document.querySelectorAll('.nav-btn')[3].classList.add('active');
                renderHistoryList();
            } else if (tab === 'ai') {
                document.getElementById('ai-tab').style.display = 'flex';
                document.querySelectorAll('.nav-btn')[4].classList.add('active');
            }
        }

        function addToDisplay(val) { displayBuffer += val; updateDisplayValue(); }
        function deleteLast() { displayBuffer = displayBuffer.slice(0,-1); updateDisplayValue(); }
        function updateDisplayValue() { document.getElementById('displayInput').innerText = displayBuffer || "0"; }
        function clearDisplay() { displayBuffer = ""; updateDisplayValue(); }

        function isDoubleDigit(n) { return n % 11 === 0; }

        // ---------- FIXED LOGIC FOR R (REVERSE) ----------
        function addToLedgerReal(num, logic, r1, amt1, r2, amt2) {
            let v1 = parseInt(amt1) || 0;
            let v2 = parseInt(amt2) || 0;
            let targets = [];

            if (logic === "ထိပ်") {
                for (let i = 0; i < 10; i++) targets.push(parseInt(num[0] + i));
            } else if (logic === "ဘိတ်") {
                for (let i = 0; i < 10; i++) targets.push(parseInt(i + num[num.length - 1]));
            } else if (logic === "ပွင့်") {
                let s = parseInt(num) % 10;
                for (let i = 0; i < 100; i++) {
                    if ((Math.floor(i / 10) + (i % 10)) % 10 === s) targets.push(i);
                }
            } else if (logic === "ခွေ") {
                let d = num.split('');
                for (let i = 0; i < d.length; i++) {
                    for (let j = 0; j < d.length; j++) {
                        if (i !== j) targets.push(parseInt(d[i] + d[j]));
                    }
                }
            } else if (logic === "အပူးပါခွေ") {
                let d = num.split('');
                for (let i = 0; i < d.length; i++) {
                    for (let j = 0; j < d.length; j++) {
                        targets.push(parseInt(d[i] + d[j]));
                    }
                }
            } else if (logic === "အပါ") {
                for (let i = 0; i < 10; i++) {
                    targets.push(parseInt(num + i));
                    targets.push(parseInt(i + num));
                }
                targets = [...new Set(targets)];
            } else if (logic === "အပူး+အပါ") {
                for (let i = 0; i < 10; i++) {
                    targets.push(parseInt(num + i));
                    targets.push(parseInt(i + num));
                }
            } else if (GROUPS[logic] && num) {
                filterGroupByDigit(GROUPS[logic], num).forEach(p => targets.push(parseInt(p)));
            } else if (GROUPS[num]) {
                GROUPS[num].forEach(p => targets.push(parseInt(p)));
            } else if (num) {
                targets.push(parseInt(num));
            }

            // Special case: single number with a single R flag (only one amount, and that amount has R)
            // Example: "45 R 200" should add 200 to both 45 and 54
            if (logic === "" && targets.length === 1 && ((v1>0 && r1==="R" && v2===0) || (v2>0 && r2==="R" && v1===0))) {
                let idx = targets[0];
                let rev = parseInt(idx.toString().padStart(2,'0').split('').reverse().join(''));
                let amount = v1>0 ? v1 : v2;
                // add to both original and reverse
                masterData[idx] += amount;
                if (idx !== rev) masterData[rev] += amount;
            } else {
                // Normal processing
                targets.forEach(idx => {
                    if (idx >= 0 && idx < 100) {
                        let rev = parseInt(idx.toString().padStart(2,'0').split('').reverse().join(''));
                        let isDouble = (idx % 11 === 0);

                        if (v1 > 0) {
                            if (r1 === "R") {
                                if (isDouble) {
                                    masterData[idx] += v1;
                                } else {
                                    masterData[rev] += v1;
                                }
                            } else {
                                masterData[idx] += v1;
                            }
                        }

                        if (v2 > 0) {
                            if (r2 === "R") {
                                if (isDouble) {
                                    masterData[idx] += v2;
                                } else {
                                    masterData[rev] += v2;
                                }
                            } else {
                                masterData[idx] += v2;
                            }
                        }
                    }
                });
            }

            saveLedger();
            renderLedger();
        }

        // Helper for filtering group by digit (unchanged)
        function filterGroupByDigit(groupArr, digit) {
            return groupArr.filter(n => n.includes(digit));
        }

        function calculateItemTotal(item) {
            let v1 = parseInt(item.amt1) || 0;
            let v2 = parseInt(item.amt2) || 0;
            let total = 0;

            if (item.logic === "ခွေ") {
                total = (v1 + v2) * (item.desc.length * (item.desc.length - 1));
            } else if (item.logic === "အပူးပါခွေ") {
                total = (v1 + v2) * (item.desc.length * item.desc.length);
            } else if (["ထိပ်", "ဘိတ်", "ပွင့်"].includes(item.logic)) {
                total = (v1 + v2) * 10;
            } else if (item.logic === "အပါ") {
                total = (v1 + v2) * 19;
            } else if (item.logic === "အပူး+အပါ") {
                total = (v1 + v2) * 20;
            } else if (GROUPS[item.desc]) {
                total = (v1 + v2) * GROUPS[item.desc].length;
            } else if (GROUPS[item.logic]) {
                total = (v1 + v2) * filterGroupByDigit(GROUPS[item.logic], item.desc).length;
            } else {
                // Normal number
                if (item.r1 === "R" && item.r2 === "R") {
                    total = v1 + v2;  // both R? unlikely, but keep
                } else if (item.r1 === "R") {
                    total = v1 * 2;    // one amount with R → double (both sides)
                } else if (item.r2 === "R") {
                    total = v1 + v2;    // second amount with R, first without → total sum
                } else {
                    total = v1 + v2;
                }
            }
            return total;
        }

        // ---------- FIXED PARSER FOR R PATTERNS ----------
        function processEnter() {
            let txt = displayBuffer.trim();
            if (!txt) return;

            let tokens = txt.split(/\s+/);
            let num = "", logic = "", r1 = "", amt1 = "", r2 = "", amt2 = "";
            let foundAmt1 = false;
            let foundR = false;

            for (let v of tokens) {
                if (!isNaN(v) && v !== "") {
                    // It's a number
                    if (num === "" && !GROUPS[logic]) {
                        num = v;  // first number is the main number
                    } else if (!foundAmt1) {
                        amt1 = v;
                        foundAmt1 = true;
                    } else {
                        amt2 = v;
                    }
                } else if (v === "R") {
                    if (!foundAmt1) {
                        // R appears before any amount: this R belongs to first amount (if any) or indicates reverse for the only amount later
                        r1 = "R";
                    } else {
                        r2 = "R";
                    }
                } else if (["ထိပ်", "ဘိတ်", "ပွင့်", "ခွေ", "အပူးပါခွေ", "ပါဝါ", "နတ်က္ခ", "အပူး", "ညီကို", "အပါ", "အပူး+အပါ"].includes(v)) {
                    logic = v;
                }
            }

            // If we have a number and at least one amount, create voucher
            if ((num !== "" || GROUPS[logic]) && (amt1 !== "" || amt2 !== "")) {
                currentVouchers.push({
                    id: Date.now() + Math.random(),
                    desc: (num || logic),
                    logic: (num ? logic : ''),
                    r1: r1,
                    amt1: amt1,
                    r2: r2,
                    amt2: amt2
                });
                clearDisplay();
                renderVoucherList();
            } else {
                alert("ပုံစံမှားနေပါသည်။ ဥပမာ - 45 R 200 သို့မဟုတ် 12 100 R 200");
            }
        }

        function renderVoucherList() {
            let html = "", total = 0;
            currentVouchers.forEach((item, i) => {
                let itemTotal = calculateItemTotal(item);
                total += itemTotal;
                let desc = item.desc + (item.logic ? '/' + item.logic : '');
                html += `<div class="voucher-row">
                    <div>${i+1}</div>
                    <div style="color:${item.logic ? '#aaffaa' : '#fff'}">${desc}</div>
                    <div>${item.logic || ''}</div>
                    <div style="color:#ff5555">${item.r1}</div>
                    <div>${item.amt1}</div>
                    <div style="color:#ff5555">${item.r2}</div>
                    <div>${item.amt2 > 0 ? item.amt2 : '-'}</div>
                    <div style="color:#39ff14">${itemTotal.toLocaleString()}</div>
                    <div><button class="delete-btn" onclick="removeItem(${i})">✖</button></div>
                </div>`;
            });
            document.getElementById('voucherList').innerHTML = html || '<div style="padding:20px; text-align:center; color:#666;">စာရင်းမရှိသေး</div>';
            document.getElementById('posTotal').innerText = total.toLocaleString() + ' Ks';
        }

        function removeItem(i) { currentVouchers.splice(i, 1); renderVoucherList(); }
        function addToLedger(item) { addToLedgerReal(item.desc, item.logic, item.r1, item.amt1, item.r2, item.amt2); }

        // ---------- LARGER PNG VOUCHER CANVAS ----------
        function showPreviewModal() {
            if (!currentVouchers.length) { alert("စာရင်းမရှိပါ"); return; }
            let editHTML = '<div style="background:#f5f5f5; padding:10px; border-radius:8px;">';
            currentVouchers.forEach((item, i) => {
                editHTML += `<div class="preview-edit-row">
                    <input class="preview-edit-input" value="${item.desc || ''}" placeholder="နံပါတ်" onchange="updatePreviewItem(${i},'desc',this.value)">
                    <input class="preview-edit-input" value="${item.logic || ''}" placeholder="Logic" onchange="updatePreviewItem(${i},'logic',this.value)">
                    <input class="preview-edit-input" value="${item.r1 || ''}" placeholder="R1" style="width:40px;" onchange="updatePreviewItem(${i},'r1',this.value)">
                    <input class="preview-edit-input" type="number" value="${item.amt1 || ''}" placeholder="Amt1" style="width:70px;" onchange="updatePreviewItem(${i},'amt1',this.value)">
                    <input class="preview-edit-input" value="${item.r2 || ''}" placeholder="R2" style="width:40px;" onchange="updatePreviewItem(${i},'r2',this.value)">
                    <input class="preview-edit-input" type="number" value="${item.amt2 || ''}" placeholder="Amt2" style="width:70px;" onchange="updatePreviewItem(${i},'amt2',this.value)">
                    <span style="font-weight:bold;">${calculateItemTotal(item)}</span>
                    <button onclick="removePreviewItem(${i})" style="background:var(--danger); color:white; border:none; border-radius:4px; padding:4px;">✖</button>
                </div>`;
            });
            editHTML += `<div style="margin-top:10px;"><button onclick="addNewPreviewItem()" style="width:100%; padding:8px; background:var(--success); color:white; border:none; border-radius:4px;">➕ အသစ်ထည့်</button></div>`;
            editHTML += '</div>';
            document.getElementById('previewEditArea').innerHTML = editHTML;
            updatePreviewCanvas();
            document.getElementById('previewModal').classList.add('active');
        }

        function updatePreviewItem(i, f, val) { 
            if (f === 'amt1' || f === 'amt2') val = parseInt(val) || 0; 
            currentVouchers[i][f] = val; 
            updatePreviewCanvas(); 
        }

        function removePreviewItem(i) { 
            currentVouchers.splice(i, 1); 
            if (currentVouchers.length) showPreviewModal(); else closeModal();
            renderVoucherList(); 
        }

        function addNewPreviewItem() { 
            currentVouchers.push({id: Date.now(), desc: '', logic: '', r1: '', amt1: 0, r2: '', amt2: 0}); 
            showPreviewModal(); 
        }

        function closeModal() { 
            document.getElementById('previewModal').classList.remove('active'); 
        }

        function updatePreviewCanvas() {
            const canvas = document.getElementById('printCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 600;  // larger width
            canvas.height = 250 + currentVouchers.length * 45;  // more space
            ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = "#000";
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', {month:'2-digit', day:'2-digit', year:'numeric'});
            ctx.font = "16px monospace"; ctx.fillStyle = "#333"; ctx.textAlign = "left"; ctx.fillText(dateStr, 20, 30);
            ctx.font = "bold 24px monospace"; ctx.fillStyle = "#000"; ctx.textAlign = "center"; ctx.fillText("AMO 2D LOTTERY POS VOUCHER", canvas.width/2, 70);
            ctx.beginPath(); ctx.moveTo(20, 90); ctx.lineTo(canvas.width-20, 90); ctx.strokeStyle = "#333"; ctx.lineWidth = 2; ctx.stroke();
            ctx.textAlign = "left"; ctx.font = "18px monospace"; let y = 120, total = 0;
            currentVouchers.forEach(item => {
                let itemTotal = calculateItemTotal(item); total += itemTotal;
                let displayText = `${item.desc} ${item.logic || ''} ${item.amt1 || 0}`;
                if (item.r1 === 'R') displayText += ' R';
                if (item.amt2 && item.amt2 > 0) {
                    displayText += ` ${item.amt2 || 0}`;
                    if (item.r2 === 'R') displayText += ' R';
                }
                ctx.fillStyle = "#000"; ctx.font = "18px monospace"; ctx.fillText(displayText, 20, y);
                ctx.fillStyle = "#2e7d32"; ctx.fillText(itemTotal.toLocaleString(), 450, y);
                y += 40;
            });
            ctx.beginPath(); ctx.moveTo(20, y-5); ctx.lineTo(canvas.width-20, y-5); ctx.stroke();
            ctx.font = "bold 24px monospace"; ctx.textAlign = "right"; ctx.fillStyle = "#000"; ctx.fillText(`စုစုပေါင်း ${total.toLocaleString()} Ks`, canvas.width-30, y+30);
            ctx.textAlign = "center"; ctx.font = "italic 20px monospace"; ctx.fillStyle = "#2e7d32"; ctx.fillText("မိတ်ဆွေကံကောင်းပါစေ", canvas.width/2, y+60);
        }

        function printOnly() {
            let total = currentVouchers.reduce((s,i) => s+calculateItemTotal(i),0);
            let voucher = { id:Date.now(), timestamp:new Date().toLocaleString('my-MM'), items:JSON.parse(JSON.stringify(currentVouchers)), total, status:"PRINTED_ONLY" };
            voucherHistory.unshift(voucher); if(voucherHistory.length>50) voucherHistory.pop(); saveHistory();
            let canvas = document.getElementById('printCanvas');
            let link = document.createElement('a'); link.download = `voucher_${Date.now()}.png`; link.href = canvas.toDataURL(); link.click();
            closeModal(); renderHistoryList();
        }

        function printAndAddToLedger() {
            currentVouchers.forEach(v => addToLedger(v));
            let total = currentVouchers.reduce((s,i) => s+calculateItemTotal(i),0);
            let voucher = { id:Date.now(), timestamp:new Date().toLocaleString('my-MM'), items:JSON.parse(JSON.stringify(currentVouchers)), total, status:"COMPLETED" };
            voucherHistory.unshift(voucher); if(voucherHistory.length>50) voucherHistory.pop(); saveHistory();
            let canvas = document.getElementById('printCanvas');
            let link = document.createElement('a'); link.download = `voucher_${Date.now()}.png`; link.href = canvas.toDataURL(); link.click();
            currentVouchers = []; renderVoucherList(); closeModal(); renderHistoryList(); renderLedger();
        }

        // ---------- SNIPER (unchanged) ----------
        async function fetchLiveData() {
            try {
                const res = await fetch('https://api.thaistock2d.com/live');
                if (!res.ok) throw new Error('API error');
                const data = await res.json();
                if (data.live) return { set: data.live.set.replace(/,/g,''), value: data.live.value.replace(/,/g,''), twod: data.live.twod };
                throw new Error('Invalid response');
            } catch(e) {
                let setVal = (1350+Math.random()*50).toFixed(2);
                let valVal = (14200+Math.random()*100).toFixed(2);
                return { set: setVal, value: valVal, twod:'--' };
            }
        }

        function startSniper() {
            if (sniperInterval) clearInterval(sniperInterval);
            sniperInterval = setInterval(async ()=>{
                const now = new Date();
                document.getElementById('sniperTime').innerText = now.toLocaleTimeString('en-GB',{hour12:false});
                const hour = now.getHours(), minute = now.getMinutes();
                const passedTarget = (hour===16 && minute>=0) || hour>16;
                const live = await fetchLiveData();
                document.getElementById('setIndex').innerText = live.set;
                document.getElementById('setValue').innerText = live.value;
                let setLast = live.set.includes('.') ? live.set.split('.')[1]?.slice(-1)||'0' : live.set.slice(-1);
                let valLast = live.value.includes('.') ? live.value.split('.')[0].slice(-1) : live.value.slice(-1);
                let currentPred = setLast + valLast;
                document.getElementById('live2D').innerText = live.twod!=='--' ? live.twod : currentPred;
                const panel = document.getElementById('sniperPanel'), statusEl = document.getElementById('sniperStatus'), predEl = document.getElementById('sniperPrediction');
                if (passedTarget && !isSniperLocked) {
                    isSniperLocked = true; panel.classList.add('locked'); statusEl.innerText = '🔒 TARGET LOCKED (16:00)'; statusEl.classList.add('blink');
                } else if (!passedTarget) {
                    isSniperLocked = false; panel.classList.remove('locked'); statusEl.innerText = 'LIVE STREAMING...'; statusEl.classList.remove('blink');
                }
                predEl.innerText = isSniperLocked ? currentPred : '--';
            },2000);
        }

        function webSearch() {
            let q = document.getElementById('webSearchInput').value.trim();
            if (!q) return;
            document.getElementById('searchResult').innerHTML = '🔍 Searching...';
            setTimeout(()=> document.getElementById('searchResult').innerHTML = `"${q}" - demo`, 1000);
        }

        // ---------- LEDGER (unchanged) ----------
        function renderLedger() {
            let col1='', col2='', total=0;
            for (let i=0;i<100;i++) {
                total += masterData[i];
                let cell = ledgerEditMode ? `<input type="number" class="ledger-edit-input" value="${masterData[i]}" onchange="updateLedgerCell(${i}, this.value)">` : (masterData[i]>0 ? masterData[i].toLocaleString() : '-');
                let row = `<div class="ledger-item"><span class="ledger-num">${i.toString().padStart(2,'0')}</span><span>${cell}</span></div>`;
                if (i<50) col1+=row; else col2+=row;
            }
            document.getElementById('ledgerGrid').innerHTML = `<div class="ledger-col">${col1}</div><div class="ledger-col">${col2}</div>`;
            document.getElementById('grandTotal').innerText = total.toLocaleString()+' Ks';
        }

        function updateLedgerCell(i,val) { masterData[i] = parseInt(val)||0; saveLedger(); renderLedger(); }
        function toggleLedgerEdit() { ledgerEditMode = !ledgerEditMode; renderLedger(); }

        // ---------- QR (unchanged) ----------
        function generateQR() {
            let total = masterData.reduce((a,b)=>a+b,0);
            if (total===0) { alert("စာရင်းမရှိပါ"); return; }
            let data = { type:"2D_LEDGER_SYNC", date:new Date().toLocaleString('my-MM'), total, master:masterData, timestamp:Date.now() };
            QRCode.toCanvas(document.getElementById('qrCanvas'), JSON.stringify(data), { width:200 }, function(err){
                if (!err) document.getElementById('qrGeneratorBox').style.display = 'block';
                else alert("QR error");
            });
        }
        function downloadQR() { let c=document.getElementById('qrCanvas'); let l=document.createElement('a'); l.download=`amo_qr_${Date.now()}.png`; l.href=c.toDataURL(); l.click(); }
        function closeQRGenerator() { document.getElementById('qrGeneratorBox').style.display = 'none'; }
        function startScanner() {
            if (!html5QrCode) html5QrCode = new Html5Qrcode("qrReader");
            document.getElementById('qrScannerBox').style.display = 'block';
            html5QrCode.start({ facingMode:"environment" }, { fps:10, qrbox:250 }, (decoded)=>{
                try {
                    let data = JSON.parse(decoded);
                    if (data.type==="2D_LEDGER_SYNC" && data.master && data.master.length===100) {
                        masterData = data.master; saveLedger(); renderLedger(); alert("✅ QR ဖတ်ပြီးပါပြီ"); stopScanner();
                    } else alert("❌ QR မှားနေသည်");
                } catch(e){ alert("❌ QR မှားနေသည်"); }
            }, ()=>{}).catch(()=>alert("Camera error"));
        }
        function stopScanner() { if(html5QrCode && html5QrCode.isScanning) html5QrCode.stop().then(()=>document.getElementById('qrScannerBox').style.display='none'); }

        // ---------- HISTORY (unchanged) ----------
        function renderHistoryList() {
            let html = '';
            voucherHistory.forEach((v,i)=>{
                let itemsPreview = v.items.map(it => it.desc+(it.logic?'/'+it.logic:'')+' '+it.amt1+(it.r1?'R':'')+' '+(it.amt2?it.amt2+(it.r2?'R':''):'')).join(', ');
                html += `<div class="history-item">
                    <div class="history-header"><span class="history-time">${v.timestamp}</span>
                        <div class="history-actions">
                            <button class="history-edit-btn" onclick="openHistoryEdit(${i})"><i class="fas fa-edit"></i> Edit</button>
                            <button class="history-delete-btn" onclick="deleteHistory(${i})"><i class="fas fa-trash"></i> Del</button>
                        </div>
                    </div>
                    <div class="history-total">စုစုပေါင်း: ${v.total.toLocaleString()} Ks</div>
                    <div class="history-items-preview">${itemsPreview}</div>
                    <div style="font-size:11px; color:#666;">${v.status} | Items: ${v.items.length}</div>
                </div>`;
            });
            document.getElementById('historyList').innerHTML = html || '<div style="padding:20px; text-align:center; color:#666;">မှတ်တမ်းမရှိသေး</div>';
            document.getElementById('historyCount').innerText = `မှတ်တမ်း ${voucherHistory.length} ခု`;
        }

        function openHistoryEdit(idx) {
            editingHistoryIndex = idx;
            let v = voucherHistory[idx];
            let editHTML = `<div style="padding:10px;"><div><label>အချိန်:</label><input type="text" id="editHistoryTime" value="${v.timestamp}" style="width:100%; padding:5px;"></div>
                <div><label>Status:</label><select id="editHistoryStatus" style="width:100%; padding:5px;">
                    <option value="PENDING" ${v.status==='PENDING'?'selected':''}>PENDING</option>
                    <option value="PRINTED_ONLY" ${v.status==='PRINTED_ONLY'?'selected':''}>PRINTED_ONLY</option>
                    <option value="COMPLETED" ${v.status==='COMPLETED'?'selected':''}>COMPLETED</option>
                </select></div>
                <div style="max-height:300px; overflow-y:auto;">`;
            v.items.forEach((item,i)=>{
                editHTML += `<div style="background:#f5f5f5; padding:8px; margin-bottom:6px;">
                    <div style="display:grid; grid-template-columns:1fr 1fr 40px 70px 40px 70px; gap:4px;">
                        <input type="text" value="${item.desc||''}" onchange="voucherHistory[${idx}].items[${i}].desc=this.value" placeholder="နံပါတ်">
                        <input type="text" value="${item.logic||''}" onchange="voucherHistory[${idx}].items[${i}].logic=this.value" placeholder="Logic">
                        <input type="text" value="${item.r1||''}" onchange="voucherHistory[${idx}].items[${i}].r1=this.value" placeholder="R1" style="width:40px;">
                        <input type="number" value="${item.amt1||''}" onchange="voucherHistory[${idx}].items[${i}].amt1=parseInt(this.value)||0" placeholder="Amt1" style="width:70px;">
                        <input type="text" value="${item.r2||''}" onchange="voucherHistory[${idx}].items[${i}].r2=this.value" placeholder="R2" style="width:40px;">
                        <input type="number" value="${item.amt2||''}" onchange="voucherHistory[${idx}].items[${i}].amt2=parseInt(this.value)||0" placeholder="Amt2" style="width:70px;">
                    </div>
                    <button onclick="removeHistoryItem(${idx}, ${i})" style="background:#ff4444; color:white; border:none; padding:4px 8px; margin-top:6px;">ဖျက်</button>
                </div>`;
            });
            editHTML += `<button onclick="addHistoryItem(${idx})" style="background:#4CAF50; color:white; border:none; padding:8px; width:100%;">➕ အသစ်ထည့်</button>`;
            editHTML += `</div><div><label>စုစုပေါင်း:</label><input type="number" id="editHistoryTotal" value="${v.total}" style="width:100%; padding:5px;"></div></div>`;
            document.getElementById('historyEditContent').innerHTML = editHTML;
            document.getElementById('historyEditModal').classList.add('active');
        }
        function removeHistoryItem(hi,ii) { voucherHistory[hi].items.splice(ii,1); openHistoryEdit(hi); }
        function addHistoryItem(hi) { voucherHistory[hi].items.push({desc:'',logic:'',r1:'',amt1:0,r2:'',amt2:0}); openHistoryEdit(hi); }
        function closeHistoryEdit() { document.getElementById('historyEditModal').classList.remove('active'); editingHistoryIndex=-1; }
        function saveHistoryEdit() {
            if (editingHistoryIndex>=0) {
                voucherHistory[editingHistoryIndex].timestamp = document.getElementById('editHistoryTime').value;
                voucherHistory[editingHistoryIndex].status = document.getElementById('editHistoryStatus').value;
                voucherHistory[editingHistoryIndex].total = parseInt(document.getElementById('editHistoryTotal').value)||0;
                saveHistory(); renderHistoryList();
            }
            closeHistoryEdit();
        }
        function deleteHistory(i) { if(confirm('ဖျက်မလား?')) { voucherHistory.splice(i,1); saveHistory(); renderHistoryList(); } }

        // ---------- STORAGE ----------
        function saveLedger() { localStorage.setItem('amo_ledger_final', JSON.stringify(masterData)); }
        function loadLedger() { let s = localStorage.getItem('amo_ledger_final'); if(s) masterData = JSON.parse(s); }
        function saveHistory() { localStorage.setItem('amo_history_final', JSON.stringify(voucherHistory)); }
        function loadHistory() { let s = localStorage.getItem('amo_history_final'); if(s) voucherHistory = JSON.parse(s); }
        function resetAllData() {
            if(confirm("စာရင်းအားလုံးဖျက်မည် သေချာလား?")) {
                masterData.fill(0); voucherHistory=[]; currentVouchers=[]; saveLedger(); saveHistory(); renderLedger(); renderHistoryList(); renderVoucherList(); alert("✅ ဖျက်ပြီးပါပြီ");
            }
        }

        // ==================== AI CHAT FUNCTIONALITY ====================
        const AI_API_KEY = "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";
        const AI_MODEL = "deepseek/deepseek-chat";

        function aiAddMsg(who, text) {
            const container = document.getElementById('aiChatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-msg ${who}`;
            msgDiv.innerHTML = `<b>${who === 'user' ? 'မင်း' : 'AI'}:</b><br>${aiFormatMessage(text)}`;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        function aiAddSystemMsg(text) {
            const container = document.getElementById('aiChatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'chat-msg system';
            msgDiv.innerText = text;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        function aiFormatMessage(text) {
            let formatted = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            formatted = formatted.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
            formatted = formatted.replace(/`([^`\n]+)`/g, '<code>$1</code>');
            formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            return formatted;
        }

        async function aiSend() {
            const input = document.getElementById('aiChatInput');
            const msg = input.value.trim();
            if (!msg) return;
            aiAddMsg('user', msg);
            input.value = '';

            const loadingId = 'ai-loading-' + Date.now();
            const loadingDiv = document.createElement('div');
            loadingDiv.id = loadingId;
            loadingDiv.className = 'chat-msg ai';
            loadingDiv.innerHTML = `<b>AI:</b> စဉ်းစားနေပါတယ်... ⏳`;
            document.getElementById('aiChatMessages').appendChild(loadingDiv);

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${AI_API_KEY}`,
                        "HTTP-Referer": window.location.href,
                        "X-Title": "MASTER 2D AI"
                    },
                    body: JSON.stringify({
                        model: AI_MODEL,
                        messages: [
                            { role: "system", content: "မင်းက ယဉ်ကျေးပျူငှာတဲ့ Customer Service ဝန်ထမ်းဖြစ်တယ်။ မေးသမျှကို အသေးစိတ်ဖြေကြားပေးရမယ်။" },
                            { role: "user", content: msg }
                        ],
                        temperature: 0.7,
                        max_tokens: 2000
                    })
                });
                document.getElementById(loadingId)?.remove();
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                const reply = data.choices[0].message.content;
                aiAddMsg('ai', reply);
            } catch (e) {
                document.getElementById(loadingId)?.remove();
                console.error(e);
                let errorMsg = "⚠️ အမှားဖြစ်နေပါတယ်။ ";
                if (e.message.includes("401") || e.message.includes("api key")) errorMsg += "API Key မှားနေပါတယ်။";
                else if (e.message.includes("429")) errorMsg += "အသုံးပြုမှု ကန့်သတ်ချက်ပြည့်သွားပါပြီ။";
                else errorMsg += "အင်တာနက်ချိတ်ဆက်မှု ပြဿနာရှိနေပါသည်။";
                aiAddSystemMsg("❌ " + errorMsg);
            }
        }
    </script>
    <!-- STRICT PROHIBITION LICENSE NOTICE -->
    <!-- This software is provided for lawful purposes only. User assumes all responsibility for compliance with local laws. -->
</body>
</html>
